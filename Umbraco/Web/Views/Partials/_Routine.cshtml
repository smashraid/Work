@model Dictionary<string, string>
@{
    Dictionary<string, string> x = (Dictionary<string, string>)Model;
    string gymnastId = Model["gymnastid"];
    string memberId = Model["memberid"];
    string workoutId = Model["workoutid"];
}
@*<button data-bind="click: add, clickBubble: false" class="btn btn-primary" id="add">
    <i class="ui-icon ui-icon-plus"></i>
</button>*@
<div class="form-horizontal" id="dialog">
</div>
<div id="content-routine">
    <div>
        <fieldset>
            <legend>Routine</legend>
            <div class="row-fluid">
                <table class="table table-striped table-hover table-condensed">
                    <caption>
                    </caption>
                    <thead>
                        <tr>
                            <th>
                                Id
                            </th>
                            <th>
                                Exercise
                            </th>
                            <th>
                                Sets
                            </th>
                            <th>
                                Reps
                            </th>
                            <th>
                                Resistance
                            </th>
                            <th>
                                Unit
                            </th>
                        </tr>
                    </thead>
                    <tbody data-bind="foreach: routines">
                        <tr>
                            <td data-bind="text: Id">
                            </td>
                            <td data-bind="text: Exercise.ExerciseName">
                            </td>
                            <td data-bind="text: Sets">
                            </td>
                            <td data-bind="text: Reps">
                            </td>
                            <td data-bind="text: Resistance">
                            </td>
                            <td data-bind="text: Unit">
                            </td>
                            <td>
                                <button class="btn" data-bind="click: $root.deleteRoutine">
                                    <i class="ui-icon ui-icon-trash"></i>
                                </button>
                                <button class="btn" data-bind="click: $root.updateRoutine">
                                    <i class="ui-icon ui-icon-pencil"></i>
                                </button>
                                <button class="btn" data-bind="click: $root.historyRoutine">
                                    <i class="ui-icon ui-icon-clipboard"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </fieldset>
    </div>
    <!-- Button to trigger modal -->
    @*<a href="#modal-routine" role="button" class="btn" data-toggle="modal" data-keyboard="false" data-backdrop="false"><i class="icon-plus"></i></a>*@
    <button type="button" class="btn" data-bind="click: openModal" ><i class="icon-plus"></i></button>
    <!-- Modal -->
    <div id="modal-routine" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3 id="myModalLabel">Add Routine</h3>
        </div>
        <form data-bind="submit: saveRoutine">
        <div class="modal-body" data-bind="foreach: newRoutines">
            <div class="row-fluid">
                <div class="span6">
                    <div class="control-group">
                        <label class="control-label" for="category">
                            Category
                        </label>
                        <div class="controls">
                            <select data-bind='options: $root.categories, optionsText: "Value", optionsValue: "Id", optionsCaption: "Select...", value: $root.category, uniqueName: true'>
                            </select>
                            <span data-bind="text: $root.category"></span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="exercise">
                            Exercise
                        </label>
                        <div class="controls">
                            <select data-bind='options: $root.exercises, optionsText: "ExerciseName", optionsValue: "Id", optionsCaption: "Select...", value: Routine.ExerciseId, uniqueName: true'>
                            </select>
                            <span data-bind="text: Routine.ExerciseId"></span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="resistance">
                            Resistence
                        </label>
                        <div class="controls">
                            <input type="text" name="resistance" id="resistance" class="input-small" data-bind="value: Routine.Resistance" />
                            <select data-bind='options: $root.units, optionsText: "Value", optionsValue: "Id", optionsCaption: "...", value: Routine.UnitId'
                                class="span4">
                            </select>
                        </div>
                    </div>
                </div>
                <div class="span6">
                    <div class="control-group">
                        <label class="control-label" for="sets">
                            Sets
                        </label>
                        <div class="controls">
                            <input type="text" name="sets" id="sets" data-bind="value: Routine.Sets" />
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="reps">
                            Reps
                        </label>
                        <div class="controls">
                            <input type="text" name="reps" id="reps" data-bind="value: Routine.Reps" />
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">
                            Note</label>
                        <div class="controls">
                            <textarea name="note" placeholder="Note" rows="5" cols="5" data-bind="value: Routine.Note"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="control-group">
                <div class="controls">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-success" data-bind="click: $root.addRoutine">Add Exercise</button>
            <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
            <button class="btn btn-primary" type="submit">Save</button>
        </div>
        </form>
    </div>
</div>
<link href="/css/ui/jquery.ui.css" rel="stylesheet" type="text/css" />
<script src="/scripts/jquery.js" type="text/javascript"></script>
<script src="/scripts/bootstrap.js" type="text/javascript"></script>
<script src="/scripts/knockout.js" type="text/javascript"></script>
<script type="text/javascript">

//        $('select[name="category"]').change(function () {
//            var option = $(this).val();
//            if (option != "") {
//                var url = '/api/member/GetExerciseByCategory';
//                $.get(url, { categoryid: option, trainerid: 0 }, function (data) {
//                    $('select[name="exercise"]').empty();
//                    $.each(data, function (index, element) {
//                        $('select[name="exercise"]').append(new Option(element.ExerciseName, element.Id, false, false));
//                    });
//                });
//            }
//        });

//        $("#dialog").dialog({
//            autoOpen: false,
//            resizable: false,
//            height: 440,
//            width: 400,
//            title: 'Add Topic',
//            modal: true,
//            buttons: {
//                "Save": function () {
//                },
//                Cancel: function () {
//                    $(this).dialog("close");
//                }
//            }
//        });

//        $('.ui-dialog-buttonset').find('span').each(function (index, element) {
//            if (element.innerHTML == "Save") {
//                $(element).parent().attr('data-bind', 'click: save');
//            }
//        });

    function StoryViewModel() {
        var self = this;
        self.Id = ko.observable();
        self.ActionId = ko.observable();
        self.Action = ko.observable();
        self.TrainingId = ko.observable();
        self.Training = ko.observable();
        self.UnitId = ko.observable();
        self.Unit = ko.observable();
        self.ObjectId = ko.observable();
        self.ObjectType = ko.observable();
        self.Value = ko.observable();
        self.TypeId = ko.observable();
        self.Type = ko.observable();
        self.UserId = ko.observable();
        self.UserType = ko.observable();
        self.Note = ko.observable();
        self.CreatedDate = ko.observable();
        self.UpdatedDate = ko.observable();
    }

    function SuperSetViewModel() {
        var self = this;
        self.Id = ko.observable();
        self.WorkoutId = ko.observable();
        self.Reps = ko.observable();
        self.Sets = ko.observable();
        self.ResistanceId = ko.observable();
        self.Resistance = ko.observable();
        self.UnitId = ko.observable();
        self.Unit = ko.observable();
        self.Note = ko.observable();
    }

    function Model() {
        var self = this;
        self.Routine = new RoutineViewModel();
        self.Stories = ko.observableArray([new StoryViewModel()]);
    }

    function RoutineViewModel() {
        var self = this;
        self.Id = ko.observable();
        self.DocumentId = ko.observable();
        self.CategoryId = ko.observable();
        self.ExerciseId = ko.observable();
        self.UserId = ko.observable();
        self.UserType = ko.observable();
        self.ObjectId = ko.observable(@workoutId);
        self.ObjectType = ko.observable();
        self.StateId = ko.observable();
        self.State = ko.observable();
        self.Exercise = ko.observable();
        self.CreatedDate = ko.observable();
        self.StartedDate = ko.observable();
        self.CompletedDate = ko.observable();
        self.CanceledDate = ko.observable();
        self.SortOrder = ko.observable();
        self.Reps = ko.observable();
        self.Sets = ko.observable();
        self.Resistance = ko.observable();
        self.UnitId = ko.observable();
        self.Unit = ko.observable();
        self.Note = ko.observable();
        //self.exercises = ko.observableArray();
        //self.CategoryId.subscribe(function() {
        //    $.get('/api/member/GetExerciseByCategory', { categoryid: self.CategoryId() }, function(data) {
        //        self.exercises(data);
        //    });
        //    self.ExerciseId(undefined);
        //});
    }

    function RoutinesViewModel() {
        var self = this;
        // self.routines = ko.observableArray(ko.utils.arrayMap(routines, function (routine) {
        //     return { Id: routine.Id, Exercise: routine.Exercise, Sets: routine.Sets, Reps: routine.Reps, Resistance: routine.Resistance, Unit: routine.Unit, Note: routine.Note };
        // }));
        self.routines = ko.observableArray();
        self.newRoutines = ko.observableArray([new Model()]);
        self.categories = ko.observableArray();
        self.category = ko.observableArray();
        self.exercises = ko.observableArray();
        self.category.subscribe(function() {
            $.get('/api/member/GetExerciseByCategory', { categoryid: self.category() }, function(data) {
                self.exercises(data);
            });
            //self.ExerciseId(undefined);
        });
        //self.category = ko.observable();
        //self.exercises = ko.observableArray();
        //self.category.subscribe(function() {
        //    $.get('/api/member/GetExerciseByCategory', { categoryid: self.category() }, function(data) {
        //        self.exercises(data);
        //    });
        //    self.exercises(undefined);
        //});
        self.superset = ko.observable();
        self.types = ko.observableArray();
        self.units = ko.observableArray();
        //self.routine = new RoutineViewModel();
        self.addRoutine = function() {
            self.newRoutines.push(new Model());
            //self.routines.push(self.routine);
            //self.routine(undefined);
        };
        self.saveRoutine = function() {
            $.ajax({
                type: "POST",
                async: false,
                //cache: false,
                url: '/api/member/InsertRoutines',
                data: ko.toJSON(self.newRoutines),
                //dataType: 'json',
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    self.getRoutine();
                     $('#modal-routine').modal('hide');
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert('Error: ' + xhr.status + ' ' + xhr.statusText);
                }
            });
        };
        self.deleteRoutine = function(routine) {
            alert(routine.Exercise + " deleted");
        };
        self.updateRoutine = function(routine) {
            alert(routine.Exercise + " updated");
        };
        self.historyRoutine = function(routine) {
            alert("showing historical");
        };
        self.getRoutine = function() {
            $('#content-routine').ajaxLoading();
            $.ajax({
                type: "GET",
                async: false,
                //cache: false,
                url: '/api/member/GetRoutineByWorkout/' + @workoutId,
                //data: { id: @memberId },
                //dataType: 'json',
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    self.routines(data);
                     $('#content-routine').closeLoading();
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert('Error: ' + xhr.status + ' ' + xhr.statusText);
                }
            });
        };
        self.getDropdown = function() {
            $.get('/api/member/GetUmbracoPreValue', { id: 1068 }, function(data) {
                self.categories(data);
            });
            $.get('/api/member/GetUmbracoPreValue', { id: 1074 }, function(data) {
                self.types(data);
            });
            $.get('/api/member/GetUmbracoPreValue', { id: 1075 }, function(data) {
                self.units(data);
            });
        };
        self.openModal = function() {
            $('#modal-routine').modal('show');
        };
    }


    $(document).ready(function() {
        var model = new RoutinesViewModel();
        ko.applyBindings(model, $('#content-routine')[0]);
        model.getDropdown();
        model.getRoutine();

        $('#modal-routine').modal({
            keyboard: false,
            backdrop:false,
            show: false
        });

        $('#modal-routine').on('hidden', function() {
            model.newRoutines([]);
            model.addRoutine();
        });
    });
    

</script>
