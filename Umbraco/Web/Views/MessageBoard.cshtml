@inherits Umbraco.Web.Mvc.UmbracoTemplatePage
@{
    Layout = "_Section.cshtml";
}
<div class="container">
    <div class="header">
        <ul>
            <li class="tabOn"><a 
                href="#" ><span>
                    Message Board
                </span></a></li>
        </ul>
        <div class="top">
        </div>
    </div>
    <div class="title">
    </div>
    <div class="wrap">
        <div class="content tabpagescrollinglayer" id="tabSection123">
            @Umbraco.Field("body")
            <div>
                <button data-bind="click: addTopic" class="btn btn-primary" id="addtopic">
                    Add Topic</button>
            </div>
            <div id="topics">
                <div data-bind="foreach: topics">
                    <h3 onclick="GetPost(this);" data-bind="attr: { id: Id }">
                        <span data-bind="text: Name"></span>
                    </h3>
                    <label data-bind="date: CreatedDate">
                    </label>
                    <label data-bind="text: User">
                    </label>
                    <div data-bind="text: Description">
                    </div>
                </div>
            </div>
            <div id="dialog" style="display: none;">
                <div class="control-group">
                    <label class="control-label" for="name">
                        Name</label>
                    <div class="controls">
                        <input id="name" type="text" name="name" placeholder="Name" value="" />
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="description">
                        Description</label>
                    <div class="controls">
                        <textarea id="description" name="description" placeholder="Description" rows="8"
                            cols="35"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="footer">
    <div class="left">
    </div>
    <div class="right">
    </div>
</div>
@section script
{

    <link href="../css/ui/jquery.ui.css" rel="stylesheet" type="text/css" />
    <script src="../scripts/modernizr.js" type="text/javascript"></script>
    <script src="../scripts/jquery.js" type="text/javascript"></script>
    <script src="../scripts/jquery.ui.js" type="text/javascript"></script>
    <script src="../scripts/knockout.js" type="text/javascript"></script>
    <script src="../scripts/knockout.mapping.js" type="text/javascript"></script>


    <script type="text/javascript">


        $(document).ready(function () {
            $("#dialog").dialog({
                autoOpen: false,
                resizable: false,
                height: 440,
                width: 260,
                title: 'Add Topic',
                modal: true,
                buttons: {
                    "Save": function () {
                    },
                    Cancel: function () {
                        $(this).dialog("close");
                    }
                }
            });
            
            $('.ui-dialog-buttonset').find('span').each(function (index, element) {
                if (element.innerHTML == "Save") {
                    $(element).parent().attr('data-bind', 'click: saveTopic');
                }
            });

            function TopicViewModel(topics) {
                var self = this;
                self.topics = ko.observableArray(ko.utils.arrayMap(topics, function (topic) {
                    return { Id: topic.Id, Name: topic.Name, Description: topic.Description, User: topic.User, CreatedDate: topic.CreatedDate };
                }));
                self.addTopic = function () {
                    $("#dialog").dialog("open");
                };
                self.saveTopic = function () {
                    $.post('/umbraco/surface/HelperSurface/SetTopic', { name: $('#name').val(), description: $('#description').val() }, function (data) {
                        self.topics.unshift({ Id: data.Id, Name: data.Name, Description: data.Description, User: data.User, CreatedDate: data.CreatedDate });
                        $("#dialog").dialog("close");
                    });
                };
            }

            function GetTopic() {
                $.get('/umbraco/surface/HelperSurface/GetTopic', function (data) {
                    ko.applyBindings(new TopicViewModel(data));
                });
            }

            GetTopic();
        });

        function GetPost(element) {
            var id = $(element).attr('id');
            parent.right.document.location.href = '/post.aspx?id=' + id;
        }

        
    </script>
}

